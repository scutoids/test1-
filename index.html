<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>AR 二项分布 (实时拖动 + LiDAR)</title>
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/AR-js-org/aframe-arkit@master/dist/aframe-arkit.min.js"></script>

  <style>
    body { margin: 0; overflow: hidden; font-family: -apple-system, sans-serif; }
    .info { position: absolute; top: 15px; left: 15px; right: 15px; color: #fff; background: rgba(0,0,0,0.7); padding: 12px; border-radius: 12px; font-size: 15px; text-align: center; z-index: 100; }
    .control { position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.85); padding: 16px; border-radius: 18px; color: white; width: 90%; max-width: 360px; z-index: 100; box-shadow: 0 6px 16px rgba(0,0,0,0.3); }
    
    .slider-container { margin: 12px 0; text-align: center; }
    .slider-label { display: block; margin-bottom: 6px; font-weight: bold; font-size: 15px; }
    .slider-value { display: inline-block; width: 50px; font-weight: bold; color: #4a90e2; }
    input[type="range"] {
      -webkit-appearance: none; width: 100%; height: 8px; border-radius: 5px; background: #444; outline: none; margin: 10px 0;
    }
    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none; width: 24px; height: 24px; border-radius: 50%; background: #007aff; cursor: pointer; box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    }
    
    .lidar-status { position: absolute; top: 80px; left: 50%; transform: translateX(-50%); background: #34c759; color: white; padding: 6px 14px; border-radius: 20px; font-size: 13px; font-weight: bold; z-index: 100; display: none; }
  </style>
</head>
<body>

<div class="info" id="info">LiDAR 启动中…</div>
<div class="lidar-status" id="lidarStatus">LiDAR 已激活</div>

<!-- 滾動條控制面板（实时更新） -->
<div class="control">
  <div class="slider-container">
    <span class="slider-label">n (試驗次數): <span class="slider-value" id="nValue">10</span></span>
    <input type="range" min="1" max="20" value="10" id="nSlider">
  </div>
  <div class="slider-container">
    <span class="slider-label">p (成功機率): <span class="slider-value" id="pValue">0.50</span></span>
    <input type="range" min="0" max="100" value="50" step="1" id="pSlider">
  </div>
</div>

<a-scene
  embedded
  vr-mode-ui="enabled: false"
  renderer="colorManagement: true; physicallyCorrectLights: true; toneMapping: acesFilmic;"
  arjs="sourceType: webcam;"
  location-based
  aframe-arkit
  aframe-arkit-device
  light="ambientIntensity: 1.5; environment: default;"
>
  <a-entity id="modelGroup" position="0 0.05 -1" scale="0.5 0.5 0.5"></a-entity>
  <a-camera></a-camera>
</a-scene>

<script>
  let currentN = 10, currentP = 0.5;
  const SCALE_Y = 6, BAR_WIDTH = 0.08, SPACING = 0.12;
  const scene = document.querySelector('#modelGroup');
  const infoEl = document.getElementById('info');
  const lidarEl = document.getElementById('lidarStatus');

  // 滾動條元素
  const nSlider = document.getElementById('nSlider');
  const pSlider = document.getElementById('pSlider');
  const nValue = document.getElementById('nValue');
  const pValue = document.getElementById('pValue');

  // ========== 实时更新函数 ==========
  function updateChart() {
    drawChart(currentN, currentP);
    infoEl.innerHTML = `实时更新！<br>n=${currentN}, p=${currentP.toFixed(2)}`;
  }

  // ========== n 滾動條：拖动时实时更新 ==========
  nSlider.addEventListener('input', () => {
    currentN = parseInt(nSlider.value);
    nValue.textContent = currentN;
    updateChart(); // 实时刷新
  });

  // ========== p 滾動條：拖动时实时更新 ==========
  pSlider.addEventListener('input', () => {
    currentP = pSlider.value / 100;
    pValue.textContent = currentP.toFixed(2);
    updateChart(); // 实时刷新
  });

  // ========== LiDAR 檢測 ==========
  function checkLiDAR() {
    if (AFRAME.utils.device.isARKitCapable) {
      lidarEl.style.display = 'block';
      infoEl.innerHTML = 'LiDAR 激活！正在掃描地面…';
    } else {
      infoEl.innerHTML = '普通 AR 模式';
    }
  }

  // ========== 二项分布 ==========
  function C(n, k) {
    if (k < 0 || k > n) return 0;
    let res = 1;
    for (let i = 1; i <= k; ++i) res = res * (n - i + 1) / i;
    return Math.round(res * 100000) / 100000;
  }

  function binomialData(n, p) {
    const data = [];
    for (let k = 0; k <= n; ++k) {
      const pk = C(n, k) * Math.pow(p, k) * Math.pow(1 - p, n - k);
      data.push({ k, pk });
    }
    return data;
  }

  // ========== 繪製圖表 ==========
  function drawChart(n, p) {
    while (scene.firstChild) scene.removeChild(scene.firstChild);
    const data = binomialData(n, p);

    data.forEach(d => {
      const height = d.pk * SCALE_Y;
      const xPos = (d.k - n/2) * SPACING;

      const bar = document.createElement('a-box');
      bar.setAttribute('width', BAR_WIDTH);
      bar.setAttribute('depth', BAR_WIDTH);
      bar.setAttribute('height', height);
      bar.setAttribute('position', `${xPos} ${height/2} 0`);
      bar.setAttribute('color', '#4a90e2');
      bar.setAttribute('metalness', '0.1');
      bar.setAttribute('roughness', '0.7');
      bar.setAttribute('shadow', 'cast: true; receive: true');
      bar.setAttribute('class', 'clickable');
      bar.setAttribute('data-k', d.k);
      bar.setAttribute('data-pk', d.pk.toFixed(4));
      scene.appendChild(bar);

      const label = document.createElement('a-text');
      label.setAttribute('value', d.k.toString());
      label.setAttribute('align', 'center');
      label.setAttribute('color', '#fff');
      label.setAttribute('position', `${xPos} -0.03 0`);
      label.setAttribute('rotation', '-90 0 0');
      label.setAttribute('scale', '0.3 0.3 0.3');
      scene.appendChild(label);
    });

    // 地面
    const ground = document.createElement('a-plane');
    ground.setAttribute('width', (n + 3) * SPACING);
    ground.setAttribute('depth', 1.5);
    ground.setAttribute('position', '0 0 0');
    ground.setAttribute('rotation', '-90 0 0');
    ground.setAttribute('color', '#333');
    ground.setAttribute('opacity', '0.8');
    ground.setAttribute('transparent', 'true');
    ground.setAttribute('shadow', 'receive: true');
    scene.appendChild(ground);
  }

  // ========== 點擊交互 ==========
  scene.addEventListener('click', e => {
    const el = e.target;
    if (el.classList.contains('clickable')) {
      const k = el.getAttribute('data-k');
      const pk = el.getAttribute('data-pk');
      alert(`B(${currentN}, ${currentP.toFixed(2)})\nP(X = ${k}) = ${pk}`);
    }
  });

  // ========== 初始化 ==========
  window.onload = () => {
    checkLiDAR();
    setTimeout(() => {
      drawChart(currentN, currentP);
      infoEl.innerHTML = '实时 AR 已就绪！<br>拖动滾動條看變化';
    }, 2000);
  };

</script>
</body>
</html>
