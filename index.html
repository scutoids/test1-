<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AR 二项分布 (可调 n, p)</title>
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>

  <style>
    body { margin: 0; overflow: hidden; font-family: -apple-system, sans-serif; }
    .info {
      position: absolute; top: 10px; left: 10px; right: 10px; color: #fff;
      background: rgba(0,0,0,0.7); padding: 10px; border-radius: 8px; font-size: 14px; z-index: 100;
    }
    .control {
      position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
      background: rgba(0,0,0,0.8); padding: 12px; border-radius: 12px; color: white;
      font-size: 14px; text-align: center; z-index: 100;
    }
    input, button {
      margin: 5px; padding: 8px; border: none; border-radius: 6px; font-size: 14px;
    }
    input { width: 60px; text-align: center; }
    button { background: #4a90e2; color: white; }
  </style>
</head>
<body>

<div class="info">模型已加载！<br>下方可调整 n 和 p</div>

<!-- 控制面板 -->
<div class="control">
  <div>n: <input id="nInput" type="number" min="1" max="20" value="10"></div>
  <div>p: <input id="pInput" type="number" min="0" max="1" step="0.05" value="0.5"></div>
  <button onclick="updateChart()">更新图表</button>
</div>

<a-scene
  embedded
  vr-mode-ui="enabled: false"
  renderer="logarithmicDepthBuffer: true"
  arjs="sourceType: webcam; trackingMethod: best;"
  location-based
>
  <a-entity id="modelGroup" position="0 0 -1" scale="0.5 0.5 0.5"></a-entity>
  <a-camera></a-camera>
</a-scene>

<script>
  // ========== 参数 ==========
  let currentN = 10;
  let currentP = 0.5;
  const SCALE_Y = 6;        // 高度缩放
  const BAR_WIDTH = 0.08;   // 柱子更细
  const SPACING = 0.12;     // 间距更密
  const CONTAINER_SCALE = 0.5; // 整体缩小 50%

  const scene = document.querySelector('#modelGroup');

  // ========== 二项分布计算 ==========
  function C(n, k) {
    if (k < 0 || k > n) return 0;
    let res = 1;
    for (let i = 1; i <= k; ++i) res = res * (n - i + 1) / i;
    return Math.round(res * 100000) / 100000; // 防浮点误差
  }

  function binomialData(n, p) {
    const data = [];
    for (let k = 0; k <= n; ++k) {
      const pk = C(n, k) * Math.pow(p, k) * Math.pow(1 - p, n - k);
      data.push({ k, pk });
    }
    return data;
  }

  // ========== 绘制柱状图 ==========
  function drawChart(n, p) {
    // 清空旧模型
    while (scene.firstChild) scene.removeChild(scene.firstChild);

    const data = binomialData(n, p);

    data.forEach(d => {
      const height = d.pk * SCALE_Y;
      const xPos = (d.k - n/2) * SPACING;

      // 柱体
      const bar = document.createElement('a-box');
      bar.setAttribute('width', BAR_WIDTH);
      bar.setAttribute('depth', BAR_WIDTH);
      bar.setAttribute('height', height);
      bar.setAttribute('position', `${xPos} ${height/2} 0`);
      bar.setAttribute('color', '#4a90e2');
      bar.setAttribute('shadow', 'cast: true; receive: true');
      bar.setAttribute('class', 'clickable');
      bar.setAttribute('data-k', d.k);
      bar.setAttribute('data-pk', d.pk.toFixed(4));
      scene.appendChild(bar);

      // 标签
      const label = document.createElement('a-text');
      label.setAttribute('value', d.k.toString());
      label.setAttribute('align', 'center');
      label.setAttribute('color', '#fff');
      label.setAttribute('position', `${xPos} -0.03 0`);
      label.setAttribute('rotation', '-90 0 0');
      label.setAttribute('scale', '0.3 0.3 0.3');
      scene.appendChild(label);
    });

    // 地面
    const ground = document.createElement('a-plane');
    ground.setAttribute('width', (n + 2) * SPACING);
    ground.setAttribute('depth', 1);
    ground.setAttribute('position', '0 -0.01 0');
    ground.setAttribute('rotation', '-90 0 0');
    ground.setAttribute('color', '#2c3e50');
    ground.setAttribute('opacity', '0.7');
    scene.appendChild(ground);

    // 灯光
    scene.appendChild(Object.assign(document.createElement('a-light'), { type: 'ambient', color: '#ccc' }));
    scene.appendChild(Object.assign(document.createElement('a-light'), { type: 'directional', position: '2 3 1', intensity: '0.7' }));
  }

  // ========== 点击交互 ==========
  scene.addEventListener('click', function (e) {
    const el = e.target;
    if (el.classList.contains('clickable')) {
      const k = el.getAttribute('data-k');
      const pk = el.getAttribute('data-pk');
      alert(`B(${currentN}, ${currentP})\nP(X = ${k}) = ${pk}`);
    }
  });

  // ========== 更新函数 ==========
  function updateChart() {
    const n = parseInt(document.getElementById('nInput').value) || 10;
    const p = parseFloat(document.getElementById('pInput').value) || 0.5;
    if (n < 1 || n > 20) { alert('n 必须在 1~20'); return; }
    if (p < 0 || p > 1) { alert('p 必须在 0~1'); return; }

    currentN = n;
    currentP = p;
    drawChart(n, p);
    document.querySelector('.info').innerHTML = `当前: n=${n}, p=${p}<br>点击柱体查看概率`;
  }

  // ========== 初始加载 ==========
  window.onload = () => {
    drawChart(currentN, currentP);
    setTimeout(() => {
      document.querySelector('.info').innerHTML = '就绪！<br>下方可调 n 和 p';
    }, 1000);
  };

</script>
</body>
</html>
