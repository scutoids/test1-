<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>AR 二项分布 (LiDAR 增强)</title>

  <!-- A-Frame -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <!-- AR.js (支持 LiDAR 的 NFT + location-based) -->
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>

  <!-- 关键：A-Frame ARKit 组件（LiDAR 支持） -->
  <script src="https://cdn.jsdelivr.net/gh/AR-js-org/aframe-arkit@master/dist/aframe-arkit.min.js"></script>

  <style>
    body { margin: 0; overflow: hidden; font-family: -apple-system, sans-serif; }
    .info {
      position: absolute; top: 15px; left: 15px; right: 15px; color: #fff;
      background: rgba(0,0,0,0.7); padding: 12px; border-radius: 12px; font-size: 15px; z-index: 100;
      text-align: center;
    }
    .control {
      position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
      background: rgba(0,0,0,0.85); padding: 14px; border-radius: 16px; color: white;
      font-size: 15px; text-align: center; z-index: 100;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }
    input, button {
      margin: 6px; padding: 10px; border: none; border-radius: 8px; font-size: 15px;
    }
    input { width: 70px; text-align: center; background: #fff; }
    button { background: #007aff; color: white; font-weight: bold; }
    .lidar-status {
      position: absolute; top: 80px; left: 50%; transform: translateX(-50%);
      background: #34c759; color: white; padding: 6px 12px; border-radius: 20px;
      font-size: 13px; font-weight: bold; z-index: 100; display: none;
    }
  </style>
</head>
<body>

<div class="info" id="info">扫描地面… 模型即将出现</div>
<div class="lidar-status" id="lidarStatus">LiDAR 已激活</div>

<!-- 控制面板 -->
<div class="control">
  <div>n: <input id="nInput" type="number" min="1" max="20" value="10"></div>
  <div>p: <input id="pInput" type="number" min="0" max="1" step="0.05" value="0.5"></div>
  <button onclick="updateChart()">更新</button>
</div>

<!-- A-Scene：自动检测是否支持 ARKit -->
<a-scene
  embedded
  vr-mode-ui="enabled: false"
  renderer="colorManagement: true; physicallyCorrectLights: true;"
  arjs="sourceType: webcam; trackingMethod: best;"
  location-based
  aframe-arkit
  aframe-arkit-device
>

  <!-- 模型容器（LiDAR 会自动贴地） -->
  <a-entity id="modelGroup" position="0 0 -1" scale="0.5 0.5 0.5"></a-entity>

  <!-- 相机 -->
  <a-camera></a-camera>

</a-scene>

<script>
  // ========== 参数 ==========
  let currentN = 10;
  let currentP = 0.5;
  const SCALE_Y = 6;
  const BAR_WIDTH = 0.08;
  const SPACING = 0.12;

  const scene = document.querySelector('#modelGroup');
  const infoEl = document.getElementById('info');
  const lidarEl = document.getElementById('lidarStatus');

  // ========== LiDAR 检测 ==========
  function checkLiDAR() {
    if (AFRAME.utils.device.isARKitCapable && AFRAME.utils.device.isMobile()) {
      lidarEl.style.display = 'block';
      infoEl.innerHTML = 'LiDAR 激活！正在扫描地面…';
      setTimeout(() => {
        infoEl.innerHTML = '地面已锁定！模型已贴地';
      }, 2000);
    } else {
      infoEl.innerHTML = '普通 AR 模式（无 LiDAR）';
    }
  }

  // ========== 二项分布 ==========
  function C(n, k) {
    if (k < 0 || k > n) return 0;
    let res = 1;
    for (let i = 1; i <= k; ++i) res = res * (n - i + 1) / i;
    return Math.round(res * 100000) / 100000;
  }

  function binomialData(n, p) {
    const data = [];
    for (let k = 0; k <= n; ++k) {
      const pk = C(n, k) * Math.pow(p, k) * Math.pow(1 - p, n - k);
      data.push({ k, pk });
    }
    return data;
  }

  // ========== 绘制图表 ==========
  function drawChart(n, p) {
    while (scene.firstChild) scene.removeChild(scene.firstChild);

    const data = binomialData(n, p);

    data.forEach(d => {
      const height = d.pk * SCALE_Y;
      const xPos = (d.k - n/2) * SPACING;

      const bar = document.createElement('a-box');
      bar.setAttribute('width', BAR_WIDTH);
      bar.setAttribute('depth', BAR_WIDTH);
      bar.setAttribute('height', height);
      bar.setAttribute('position', `${xPos} ${height/2} 0`);
      bar.setAttribute('color', '#007aff');
      bar.setAttribute('metalness', '0.3');
      bar.setAttribute('roughness', '0.4');
      bar.setAttribute('shadow', 'cast: true; receive: true');
      bar.setAttribute('class', 'clickable');
      bar.setAttribute('data-k', d.k);
      bar.setAttribute('data-pk', d.pk.toFixed(4));
      scene.appendChild(bar);

      const label = document.createElement('a-text');
      label.setAttribute('value', d.k.toString());
      label.setAttribute('align', 'center');
      label.setAttribute('color', '#ffffff');
      label.setAttribute('position', `${xPos} -0.03 0`);
      label.setAttribute('rotation', '-90 0 0');
      label.setAttribute('scale', '0.3 0.3 0.3');
      scene.appendChild(label);
    });

    // 真实地面（LiDAR 会自动贴合）
    const ground = document.createElement('a-plane');
    ground.setAttribute('width', (n + 2) * SPACING);
    ground.setAttribute('depth', 1.2);
    ground.setAttribute('position', '0 0 0');
    ground.setAttribute('rotation', '-90 0 0');
    ground.setAttribute('color', '#1a1a1a');
    ground.setAttribute('metalness', '0.1');
    ground.setAttribute('roughness', '0.8');
    ground.setAttribute('shadow', 'receive: true');
    scene.appendChild(ground);

    // 真实光照
    scene.appendChild(Object.assign(document.createElement('a-light'), {
      type: 'hemisphere', color: '#ffffff', groundColor: '#444444', intensity: 0.6
    }));
    scene.appendChild(Object.assign(document.createElement('a-light'), {
      type: 'directional', position: '2 4 2', intensity: 1.2, castShadow: true
    }));
  }

  // ========== 点击交互 ==========
  scene.addEventListener('click', e => {
    const el = e.target;
    if (el.classList.contains('clickable')) {
      const k = el.getAttribute('data-k');
      const pk = el.getAttribute('data-pk');
      alert(`B(${currentN}, ${currentP})\nP(X = ${k}) = ${pk}`);
    }
  });

  // ========== 更新函数 ==========
  function updateChart() {
    const n = parseInt(document.getElementById('nInput').value) || 10;
    const p = parseFloat(document.getElementById('pInput').value) || 0.5;
    if (n < 1 || n > 20) { alert('n 必须在 1~20'); return; }
    if (p < 0 || p > 1) { alert('p 必须在 0~1'); return; }

    currentN = n;
    currentP = p;
    drawChart(n, p);
    infoEl.innerHTML = `更新成功！n=${n}, p=${p}<br>模型已贴地`;
  }

  // ========== 初始化 ==========
  window.onload = () => {
    checkLiDAR();
    setTimeout(() => {
      drawChart(currentN, currentP);
      infoEl.innerHTML = '就绪！<br>模型已贴地，可调 n 和 p';
    }, 1500);
  };

</script>
</body>
</html>
