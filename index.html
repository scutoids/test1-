<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>AR 二項式分布（iPhone 專用）</title>
  <script src="https://cdn.jsdelivr.net/npm/three@0.157.0/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.157.0/examples/js/exporters/USDZExporter.js"></script>
  <style>
    body { margin: 0; padding: 20px; font-family: -apple-system; background: #f0f0f0; text-align: center; }
    #controls { background: white; padding: 20px; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); max-width: 400px; margin: 20px auto; }
    h2 { color: #1a1a1a; margin-bottom: 20px; }
    label { display: block; margin: 15px 0 8px; font-weight: 600; }
    input[type="range"] { width: 100%; height: 8px; border-radius: 4px; background: #ddd; }
    input[type="range"]::-webkit-slider-thumb { background: #007AFF; width: 20px; height: 20px; border-radius: 50%; }
    #values { font-size: 18px; font-weight: bold; color: #007AFF; margin: 10px 0; }
    #arButton {
      margin-top: 25px; padding: 14px 30px; font-size: 18px; font-weight: bold;
      background: #007AFF; color: white; border: none; border-radius: 12px;
      cursor: pointer; box-shadow: 0 4px 12px rgba(0,122,255,0.3);
    }
    #arButton:active { transform: scale(0.98); }
    #formula { margin-top: 15px; font-family: monospace; color: #555; }
    .info { font-size: 14px; color: #666; margin-top: 30px; }
  </style>
</head>
<body>

  <div id="controls">
    <h2>二項式分布 AR 模型</h2>
    
    <label for="n">試驗次數 n: <span id="nValue">10</span></label>
    <input type="range" id="n" min="1" max="30" value="10">

    <label for="p">成功概率 p: <span id="pValue">0.50</span></label>
    <input type="range" id="p" min="1" max="99" value="50" step="1">

    <div id="values">n = 10, p = 0.50</div>
    <div id="formula"></div>

    <button id="arButton">查看 AR 3D 模型</button>
  </div>

  <div class="info">
    <p>iPhone / iPad 專用 • 點擊按鈕後將開啟真實 AR</p>
  </div>

  <script>
    // 二項式計算
    function binomialCoeff(n, k) {
      if (k < 0 || k > n) return 0;
      let res = 1;
      for (let i = 1; i <= k; i++) res = res * (n - i + 1) / i;
      return Math.round(res * 1000) / 1000;
    }

    function binomialPMF(n, p, k) {
      return binomialCoeff(n, k) * Math.pow(p, k) * Math.pow(1 - p, n - k);
    }

    // 生成 USDZ 模型
    async function generateUSDZ(n, p) {
      const scene = new THREE.Scene();
      const probs = Array.from({length: n+1}, (_, k) => binomialPMF(n, p, k));
      const maxProb = Math.max(...probs, 0.1);
      const scaleY = 1.5 / maxProb;

      probs.forEach((prob, k) => {
        if (prob < 0.01) return;
        const height = prob * scaleY;
        const geometry = new THREE.BoxGeometry(0.15, height, 0.15);
        const material = new THREE.MeshStandardMaterial({
          color: new THREE.Color().setHSL(0.6 * (1 - prob/maxProb), 1, 0.5),
          metalness: 0.3,
          roughness: 0.4
        });
        const mesh = new THREE.Mesh(geometry, material);
        mesh.position.set((k - n/2) * 0.18, height/2, 0);
        scene.add(mesh);

        // 標籤
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = 64; canvas.height = 64;
        ctx.fillStyle = 'white';
        ctx.font = 'bold 40px Arial';
        ctx.textAlign = 'center';
        ctx.fillText(k.toString(), 32, 48);
        const texture = new THREE.CanvasTexture(canvas);
        const label = new THREE.Mesh(
          new THREE.PlaneGeometry(0.2, 0.2),
          new THREE.MeshBasicMaterial({ map: texture, transparent: true })
        );
        label.position.set((k - n/2) * 0.18, -0.1, 0);
        scene.add(label);
      });

      // 光源
      scene.add(new THREE.AmbientLight(0xffffff, 0.6));
      scene.add(new THREE.DirectionalLight(0xffffff, 0.8));

      const exporter = new THREE.USDZExporter();
      const arrayBuffer = await exporter.parse(scene);
      const blob = new Blob([arrayBuffer], { type: 'model/usdz' });
      return URL.createObjectURL(blob);
    }

    // 更新 UI
    function updateUI(n, p) {
      document.getElementById('nValue').textContent = n;
      document.getElementById('pValue').textContent = p.toFixed(2);
      document.getElementById('values').textContent = `n = ${n}, p = ${p.toFixed(2)}`;
      document.getElementById('formula').textContent = 
        `P(X=k) = C(${n},k) × ${p.toFixed(2)}^k × (${(1-p).toFixed(2)})^{${n}-k}`;
    }

    // 主邏輯
    let n = 10, p = 0.5;
    const nSlider = document.getElementById('n');
    const pSlider = document.getElementById('p');
    const arButton = document.getElementById('arButton');

    nSlider.oninput = () => { n = +nSlider.value; updateUI(n, p); };
    pSlider.oninput = () => { p = pSlider.value / 100; updateUI(n, p); };

    arButton.onclick = async () => {
      arButton.disabled = true;
      arButton.textContent = "生成中...";
      try {
        const usdzURL = await generateUSDZ(n, p);
        const a = document.createElement('a');
        a.href = usdzURL;
        a.rel = 'ar';
        a.setAttribute('data-usdz', '');
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(usdzURL);
      } catch (e) {
        alert("生成失敗，請重試");
      }
      arButton.disabled = false;
      arButton.textContent = "查看 AR 3D 模型";
    };

    // 初始化
    updateUI(n, p);
  </script>
</body>
</html>
