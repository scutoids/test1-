<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>AR Statistics Visualizer</title>
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { overflow: hidden; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #000; }

    .status-bar {
      position: absolute; top: 0; left: 0; right: 0; height: 50px;
      background: rgba(0,0,0,0.7); backdrop-filter: blur(12px);
      display: flex; align-items: center; justify-content: flex-end;
      padding: 0 16px; z-index: 300;
      border-bottom: 1px solid rgba(255,255,255,0.08);
    }
    .model-switch-btn {
      background: linear-gradient(135deg, #007aff, #5856d6); color: white;
      padding: 8px 16px; border-radius: 25px; font-size: 13px; font-weight: 600;
      cursor: pointer; user-select: none; box-shadow: 0 4px 12px rgba(0,122,255,0.3);
      transition: all 0.2s ease; display: flex; align-items: center; gap: 6px;
      min-width: 100px; justify-content: center;
    }
    .model-switch-btn:active { transform: translateY(1px); }

    .info {
      position: absolute; top: 60px; left: 16px; right: 16px;
      color: #fff; background: rgba(30,30,30,0.92); padding: 10px 14px;
      border-radius: 14px; font-size: 13px; text-align: center; z-index: 200;
      backdrop-filter: blur(16px); box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }
    .ground-detected {
      position: absolute; top: 106px; left: 50%; transform: translateX(-50%);
      background: linear-gradient(135deg, #34c759, #30d158); color: white;
      padding: 6px 16px; border-radius: 20px; font-size: 12px; font-weight: bold;
      z-index: 200; display: none; box-shadow: 0 4px 12px rgba(52,199,89,0.4);
    }

    .control {
      position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
      width: 90%; max-width: 380px; border-radius: 20px;
      background: rgba(40,40,40,0.95); backdrop-filter: blur(20px);
      box-shadow: 0 12px 32px rgba(0,0,0,0.4); z-index: 200;
      overflow: hidden; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      border: 1px solid rgba(255,255,255,0.1);
    }
    .control.collapsed { height: 60px; padding: 0 18px; }
    .control.expanded { padding: 24px 18px; }
    .control-header {
      display: flex; justify-content: space-between; align-items: center;
      height: 60px; cursor: pointer; user-select: none; font-weight: 600;
      font-size: 16px; color: #fff;
    }
    .toggle-icon { font-size: 22px; transition: transform 0.3s ease; }
    .control.collapsed .toggle-icon { transform: rotate(180deg); }
    .sliders { margin-top: 16px; opacity: 1; transition: all 0.3s ease; }
    .control.collapsed .sliders { opacity: 0; height: 0; margin: 0; overflow: hidden; pointer-events: none; }

    .slider-container { margin: 18px 0; }
    .slider-label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 14px; color: #fff; }
    .slider-value { display: inline-block; width: 70px; color: #007aff; font-weight: bold; font-size: 14px; }
    input[type=range] {
      -webkit-appearance: none; width: 100%; height: 8px; border-radius: 6px;
      background: #444; outline: none; margin: 10px 0;
    }
    input[type=range]::-webkit-slider-thumb {
      -webkit-appearance: none; width: 26px; height: 26px; border-radius: 50%;
      background: #007aff; box-shadow: 0 3px 8px rgba(0,122,255,0.4);
      cursor: pointer; transition: all 0.2s ease;
    }
    input[type=range]::-webkit-slider-thumb:active { transform: scale(1.1); }

    .zoom-controls { position: absolute; bottom: 110px; right: 20px; z-index: 200; display: flex; gap: 14px; }
    .zoom-btn {
      background: rgba(255,255,255,0.95); color: #000; border: none; width: 48px; height: 48px;
      border-radius: 50%; font-size: 22px; font-weight: bold;
      box-shadow: 0 6px 16px rgba(0,0,0,0.2); cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      transition: all 0.2s ease;
    }
    .zoom-btn:active { transform: scale(0.92); }

    .gesture-hint {
      position: absolute; bottom: 110px; left: 50%; transform: translateX(-50%);
      background: rgba(0,0,0,0.7); color: #fff; padding: 8px 16px;
      border-radius: 20px; font-size: 13px; z-index: 200; backdrop-filter: blur(8px);
    }

    .ui-dragging * { opacity: 0.4 !important; }
  </style>
</head>
<body>
  <!-- 右上角切換按鈕 -->
  <div class="status-bar">
    <div class="model-switch-btn" id="modelSwitchBtn">
      <span id="modelText">Poisson</span>
    </div>
  </div>

  <div class="info" id="info">Point camera at floor to start...</div>
  <div class="ground-detected" id="groundStatus">Ground Detected</div>

  <div class="zoom-controls">
    <button class="zoom-btn" id="zoomOutBtn">Minus</button>
    <button class="zoom-btn" id="zoomInBtn">Plus</button>
  </div>

  <div class="gesture-hint">Drag with one finger to move</div>

  <div class="control expanded" id="controlPanel">
    <div class="control-header" id="panelHeader">
      <span id="panelTitle">Poisson Settings</span>
      <span class="toggle-icon">Up Arrow</span>
    </div>
    <div class="sliders" id="sliders"></div>
  </div>

  <a-scene
    embedded
    vr-mode-ui="enabled: false"
    renderer="colorManagement: true; physicallyCorrectLights: true;"
    arjs="sourceType: webcam; trackingMethod: best; debugUIEnabled: false;"
    device-orientation-permission-ui="enabled: false"
    light="ambientIntensity: 1.5;">
    <a-entity id="modelGroup" position="0 0.1 -1" scale="0.6 0.6 0.6"
              ground-tracker drag-only zoom-control></a-entity>
    <a-camera></a-camera>
  </a-scene>

  <script>
    // ========== Config ==========
    const BAR_WIDTH = 0.05, SPACING = 0.07;
    const FIXED_BASE_Y = 0.15;
    const MAX_HEIGHT = 0.8;

    // ========== DOM ==========
    const scene = document.querySelector('#modelGroup');
    const infoEl = document.getElementById('info');
    const groundEl = document.getElementById('groundStatus');
    const switchBtn = document.getElementById('modelSwitchBtn');
    const modelText = document.getElementById('modelText');
    const panelTitle = document.getElementById('panelTitle');
    const slidersContainer = document.getElementById('sliders');
    const controlPanel = document.getElementById('controlPanel');
    const panelHeader = document.getElementById('panelHeader');
    const zoomIn = document.getElementById('zoomInBtn');
    const zoomOut = document.getElementById('zoomOutBtn');

    let mode = 'poisson';
    let zoom = 1.0;
    let lambda = 5.0, n = 10, probP = 0.5;

    // ========== 強制重繪函數 ==========
    function forceDraw() {
      updateSliders();
      draw();
      infoEl.textContent = 'Ready! Use Plus/Minus to zoom';
    }

    // ========== Model Switch ==========
    switchBtn.addEventListener('click', () => {
      mode = mode === 'poisson' ? 'binomial' : 'poisson';
      modelText.textContent = mode === 'poisson' ? 'Poisson' : 'Binomial';
      panelTitle.textContent = mode === 'poisson' ? 'Poisson Settings' : 'Binomial Settings';
      forceDraw();
    });

    // ========== Dynamic Sliders ==========
    function updateSliders() {
      slidersContainer.innerHTML = '';
      if (mode === 'poisson') {
        slidersContainer.innerHTML = `
          <div class="slider-container">
            <span class="slider-label">λ (mean rate): <span class="slider-value" id="lambdaVal">5.0</span></span>
            <input type="range" min="1" max="200" value="50" step="1" id="lambdaSlider">
          </div>`;
        document.getElementById('lambdaSlider').addEventListener('input', () => {
          lambda = document.getElementById('lambdaSlider').value / 10;
          document.getElementById('lambdaVal').textContent = lambda.toFixed(1);
          draw();
        });
      } else {
        slidersContainer.innerHTML = `
          <div class="slider-container">
            <span class="slider-label">n (trials): <span class="slider-value" id="nVal">10</span></span>
            <input type="range" min="1" max="20" value="10" id="nSlider">
          </div>
          <div class="slider-container">
            <span class="slider-label">p (probability): <span class="slider-value" id="pVal">0.50</span></span>
            <input type="range" min="0" max="100" value="50" step="1" id="pSlider">
          </div>`;
        document.getElementById('nSlider').addEventListener('input', () => {
          n = +document.getElementById('nSlider').value;
          document.getElementById('nVal').textContent = n;
          draw();
        });
        document.getElementById('pSlider').addEventListener('input', () => {
          probP = document.getElementById('pSlider').value / 100;
          document.getElementById('pVal').textContent = probP.toFixed(2);
          draw();
        });
      }
    }

    // ========== Math ==========
    const C = (n, k) => {
      if (k < 0 || k > n) return 0;
      let r = 1;
      for (let i = 1; i <= k; ++i) r = r * (n - i + 1) / i;
      return Math.round(r * 1e5) / 1e5;
    };
    const poisson = (k, λ) => Math.pow(λ, k) * Math.exp(-λ) / factorial(k);
    const factorial = n => n <= 1 ? 1 : n * factorial(n - 1);

    // ========== Draw (穩定版) ==========
    function draw() {
      while (scene.firstChild) scene.removeChild(scene.firstChild);
      let data = [], maxP = 0.001, color = '#007aff';

      if (mode === 'poisson') {
        color = '#ff9500';
        const maxK = Math.ceil(lambda + 10);
        for (let k = 0; k <= maxK; k++) {
          const p = poisson(k, lambda);
          if (p > 1e-8) data.push({k, p});
        }
      } else {
        for (let k = 0; k <= n; k++) {
          const p = C(n, k) * Math.pow(probP, k) * Math.pow(1 - probP, n - k);
          data.push({k, p});
        }
      }

      maxP = Math.max(...data.map(d => d.p), 0.001);
      const yScale = MAX_HEIGHT / maxP;
      const center = data.length > 0 ? data[Math.floor(data.length / 2)].k : 0;

      data.forEach(d => {
        const h = Math.min(d.p * yScale, MAX_HEIGHT * 2);
        const x = (d.k - center) * SPACING;

        const bar = document.createElement('a-box');
        bar.setAttribute('position', `${x} ${FIXED_BASE_Y + h/2} 0`);
        bar.setAttribute('width', BAR_WIDTH); bar.setAttribute('depth', BAR_WIDTH);
        bar.setAttribute('height', h > 0.001 ? h : 0.001);
        bar.setAttribute('color', color); bar.classList.add('clickable');
        bar.dataset.k = d.k; bar.dataset.p = d.p.toFixed(6);
        scene.appendChild(bar);

        const txt = document.createElement('a-text');
        txt.setAttribute('value', d.k); txt.setAttribute('position', `${x} ${FIXED_BASE_Y - 0.03} 0`);
        txt.setAttribute('rotation', '-90 0 0'); txt.setAttribute('scale', '0.2 0.2 0.2'); txt.setAttribute('color', '#fff');
        scene.appendChild(txt);
      });

      const plane = document.createElement('a-plane');
      plane.setAttribute('position', `0 ${FIXED_BASE_Y} 0`); plane.setAttribute('rotation', '-90 0 0');
      plane.setAttribute('width', Math.max(data.length * SPACING + 1, 2)); plane.setAttribute('depth', 1);
      plane.setAttribute('color', '#222'); plane.setAttribute('opacity', '0.7'); plane.setAttribute('transparent', 'true');
      scene.appendChild(plane);
    }

    // ========== Components ==========
    AFRAME.registerComponent('zoom-control', {
      init: function () {
        const el = this.el;
        zoomIn.addEventListener('click', () => {
          zoom = Math.min(zoom * 1.5, 3); el.setAttribute('scale', `${0.6*zoom} ${0.6*zoom} ${0.6*zoom}`);
          infoEl.textContent = `Zoom: ×${zoom.toFixed(1)}`;
        });
        zoomOut.addEventListener('click', () => {
          zoom = Math.max(zoom / 1.5, 0.3); el.setAttribute('scale', `${0.6*zoom} ${0.6*zoom} ${0.6*zoom}`);
          infoEl.textContent = `Zoom: ×${zoom.toFixed(1)}`;
        });
      }
    });

    AFRAME.registerComponent('drag-only', {
      init: function () {
        const el = this.el;
        let sx, sz, dragging = false;
        el.addEventListener('gesturestart', e => {
          if (e.detail.touches !== 1) return;
          const p = el.object3D.position;
          sx = p.x; sz = p.z; dragging = true;
          document.body.classList.add('ui-dragging');
        });
        el.addEventListener('gesturechange', e => {
          if (!dragging || e.detail.touches !== 1) return;
          const d = e.detail.delta;
          el.object3D.position.x = sx + d.x * 0.001;
          el.object3D.position.z = sz + d.z * 0.001;
        });
        el.addEventListener('gestureend', () => { dragging = false; document.body.classList.remove('ui-dragging'); });
      }
    });

    // ========== Ground Tracker (關鍵！) ==========
    AFRAME.registerComponent('ground-tracker', {
      init: function () { this.hasDrawn = false; },
      tick: function () {
        const cam = this.el.sceneEl.camera;
        if (!cam || this.hasDrawn) return;
        const ray = new THREE.Raycaster(cam.getWorldPosition(new THREE.Vector3()), new THREE.Vector3(0, -1, 0));
        const hits = ray.intersectObjects(this.el.sceneEl.object3D.children, true);
        if (hits[0]) {
          this.el.object3D.position.set(0, hits[0].point.y + 0.1, -0.8);
          groundEl.style.display = 'block';
          infoEl.textContent = 'Loading model...';
          setTimeout(() => {
            forceDraw();  // 關鍵：強制畫圖
            this.hasDrawn = true;
          }, 500);
        }
      }
    });

    // ========== Panel Toggle ==========
    let clicks = 0;
    panelHeader.addEventListener('click', () => {
      clicks++;
      if (clicks === 1) {
        setTimeout(() => { controlPanel.classList.toggle('collapsed'); controlPanel.classList.toggle('expanded'); clicks = 0; }, 300);
      } else if (clicks === 2) {
        controlPanel.style.display = controlPanel.style.display === 'none' ? 'block' : 'none';
        clicks = 0;
      }
    });

    // ========== Click Bar ==========
    scene.addEventListener('click', e => {
      if (e.target.classList.contains('clickable')) {
        const k = e.target.dataset.k, p = e.target.dataset.p;
        alert(`P(X=${k}) = ${p}`);
      }
    });

    // ========== Init (保險畫一次) ==========
    window.onload = () => {
      setTimeout(() => {
        forceDraw();
      }, 2000); // 2 秒後強制畫
    };
  </script>
</body>
</html>
